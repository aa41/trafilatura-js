<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„å¤„ç†è§„åˆ™æµ‹è¯• - Preprocessing Rules Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #34495e;
            margin-top: 0;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { 
            color: #27ae60; 
            font-weight: bold;
            font-size: 18px;
        }
        .error { 
            color: #e74c3c; 
            font-weight: bold;
            font-size: 18px;
        }
        .code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .info {
            background: #d5f4e6;
            padding: 15px;
            border-left: 4px solid #27ae60;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ é¢„å¤„ç†è§„åˆ™ç³»ç»Ÿæµ‹è¯•</h1>
    <p class="info">
        <strong>é¢„å¤„ç†è§„åˆ™</strong>å…è®¸åœ¨HTMLæå–å‰å¯¹èŠ‚ç‚¹è¿›è¡Œè‡ªå®šä¹‰å¤„ç†ï¼Œç±»ä¼¼äº 
        <a href="https://github.com/mixmark-io/turndown" target="_blank">Turndown çš„ addRule</a> åŠŸèƒ½ã€‚
    </p>
    
    <div class="test-section">
        <h2>æµ‹è¯• 1: åˆ é™¤å¹¿å‘Šå…ƒç´ </h2>
        <p>ä½¿ç”¨CSSé€‰æ‹©å™¨åˆ é™¤æ‰€æœ‰å¹¿å‘Šç›¸å…³å…ƒç´ </p>
        <div id="test1-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯• 2: è½¬æ¢è§†é¢‘å…ƒç´ ä¸ºé“¾æ¥</h2>
        <p>ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°å°† &lt;video&gt; å…ƒç´ è½¬æ¢ä¸ºæ–‡æœ¬é“¾æ¥</p>
        <div id="test2-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯• 3: ä¿®å¤æ‡’åŠ è½½å›¾ç‰‡</h2>
        <p>å°† data-lazy-src å±æ€§ç§»åŠ¨åˆ° src</p>
        <div id="test3-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯• 4: é“¾å¼è°ƒç”¨å¤šä¸ªè§„åˆ™</h2>
        <p>åŒæ—¶åº”ç”¨å¤šä¸ªè§„åˆ™è¿›è¡Œå¤æ‚å¤„ç†</p>
        <div id="test4-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯• 5: ä½¿ç”¨å‡½æ•°è¿‡æ»¤å™¨</h2>
        <p>ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å‡½æ•°ç²¾ç¡®é€‰æ‹©èŠ‚ç‚¹</p>
        <div id="test5-result"></div>
    </div>

    <script src="dist/trafilatura.browser.js"></script>
    <script>
        function displayResult(testId, success, message, code, extracted) {
            const resultDiv = document.getElementById(`test${testId}-result`);
            const statusClass = success ? 'success' : 'error';
            const statusText = success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
            
            resultDiv.innerHTML = `
                <p class="${statusClass}">${statusText}</p>
                <p>${message}</p>
                ${code ? `<div class="code">${code}</div>` : ''}
                ${extracted ? `<div class="result">${extracted}</div>` : ''}
            `;
        }

        // æµ‹è¯• 1: åˆ é™¤å¹¿å‘Šå…ƒç´ 
        function test1() {
            const html = `
                <article>
                    <h1>æµ‹è¯•æ–‡ç« </h1>
                    <div class="advertisement">è¿™æ˜¯å¹¿å‘Šå†…å®¹</div>
                    <p>è¿™æ˜¯æ­£æ–‡å†…å®¹ã€‚</p>
                    <div class="ad-banner">æ¨ªå¹…å¹¿å‘Š</div>
                    <p>æ›´å¤šæ­£æ–‡ã€‚</p>
                </article>
            `;
            
            const { Extractor } = Trafilatura;
            const extractor = new Extractor({
                format: 'markdown',
                include_images: false
            });
            
            // æ·»åŠ è§„åˆ™ï¼šåˆ é™¤å¹¿å‘Š
            extractor.addPreprocessingRule('removeAds', {
                filter: ['.advertisement', '.ad-banner'],
                action: (node) => null  // è¿”å›nullåˆ é™¤èŠ‚ç‚¹
            });
            
            const result = Trafilatura.extract(html, extractor);
            
            const hasContent = result && result.includes('æ­£æ–‡å†…å®¹');
            const noAds = result && !result.includes('å¹¿å‘Š');
            
            const code = `extractor.addPreprocessingRule('removeAds', {
  filter: ['.advertisement', '.ad-banner'],
  action: (node) => null  // è¿”å›nullåˆ é™¤èŠ‚ç‚¹
});`;
            
            displayResult(1, 
                hasContent && noAds, 
                hasContent && noAds ? 'æˆåŠŸåˆ é™¤æ‰€æœ‰å¹¿å‘Šå…ƒç´ ' : 'å¹¿å‘Šåˆ é™¤å¤±è´¥',
                code,
                result
            );
        }

        // æµ‹è¯• 2: è½¬æ¢è§†é¢‘å…ƒç´ 
        function test2() {
            const html = `
                <article>
                    <h1>è§†é¢‘æ•™ç¨‹</h1>
                    <p>è§‚çœ‹ä¸‹é¢çš„è§†é¢‘ï¼š</p>
                    <video src="https://example.com/video.mp4" title="æ•™å­¦è§†é¢‘"></video>
                    <p>è§†é¢‘ç»“æŸã€‚</p>
                </article>
            `;
            
            const { Extractor } = Trafilatura;
            const extractor = new Extractor({
                format: 'markdown',
                include_images: false
            });
            
            // æ·»åŠ è§„åˆ™ï¼šè½¬æ¢è§†é¢‘ä¸ºé“¾æ¥
            extractor.addPreprocessingRule('convertVideo', {
                filter: (node) => node.tagName === 'VIDEO',
                action: (node) => {
                    const link = document.createElement('a');
                    link.href = node.src || node.getAttribute('src') || '#';
                    link.textContent = `[è§†é¢‘: ${node.title || node.getAttribute('title') || 'æ’­æ”¾'}]`;
                    return link;  // è¿”å›æ–°èŠ‚ç‚¹æ›¿æ¢
                }
            });
            
            const result = Trafilatura.extract(html, extractor);
            
            const hasVideoLink = result && result.includes('[è§†é¢‘:');
            
            const code = `extractor.addPreprocessingRule('convertVideo', {
  filter: (node) => node.tagName === 'VIDEO',
  action: (node) => {
    const link = document.createElement('a');
    link.href = node.src;
    link.textContent = \`[è§†é¢‘: \${node.title}]\`;
    return link;  // è¿”å›æ–°èŠ‚ç‚¹æ›¿æ¢
  }
});`;
            
            displayResult(2, 
                hasVideoLink, 
                hasVideoLink ? 'æˆåŠŸå°†è§†é¢‘è½¬æ¢ä¸ºé“¾æ¥' : 'è§†é¢‘è½¬æ¢å¤±è´¥',
                code,
                result
            );
        }

        // æµ‹è¯• 3: ä¿®å¤æ‡’åŠ è½½å›¾ç‰‡
        function test3() {
            const html = `
                <article>
                    <h1>å›¾ç‰‡æµ‹è¯•</h1>
                    <img data-lazy-src="https://example.com/real.jpg" src="placeholder.gif" alt="æµ‹è¯•å›¾ç‰‡">
                    <p>å›¾ç‰‡è¯´æ˜</p>
                </article>
            `;
            
            const { Extractor } = Trafilatura;
            const extractor = new Extractor({
                format: 'markdown',
                include_images: true
            });
            
            // æ·»åŠ è§„åˆ™ï¼šä¿®å¤æ‡’åŠ è½½
            extractor.addPreprocessingRule('fixLazyImages', {
                filter: 'img[data-lazy-src]',
                action: (node) => {
                    const lazySrc = node.getAttribute('data-lazy-src');
                    if (lazySrc) {
                        node.setAttribute('src', lazySrc);
                        node.removeAttribute('data-lazy-src');
                    }
                    // ä¸è¿”å›å€¼ï¼ŒåŸåœ°ä¿®æ”¹
                }
            });
            
            const result = Trafilatura.extract(html, extractor);
            
            const hasRealImage = result && result.includes('real.jpg');
            const noPlaceholder = result && !result.includes('placeholder.gif');
            
            const code = `extractor.addPreprocessingRule('fixLazyImages', {
  filter: 'img[data-lazy-src]',
  action: (node) => {
    node.setAttribute('src', node.getAttribute('data-lazy-src'));
    node.removeAttribute('data-lazy-src');
    // ä¸è¿”å›å€¼ï¼ŒåŸåœ°ä¿®æ”¹
  }
});`;
            
            displayResult(3, 
                hasRealImage && noPlaceholder, 
                hasRealImage && noPlaceholder ? 'æˆåŠŸä¿®å¤æ‡’åŠ è½½å›¾ç‰‡' : 'å›¾ç‰‡ä¿®å¤å¤±è´¥',
                code,
                result
            );
        }

        // æµ‹è¯• 4: é“¾å¼è°ƒç”¨å¤šä¸ªè§„åˆ™
        function test4() {
            const html = `
                <article>
                    <h1>ç»¼åˆæµ‹è¯•</h1>
                    <div class="ad">å¹¿å‘Š1</div>
                    <p>æ­£æ–‡æ®µè½</p>
                    <img data-lazy-src="https://example.com/image.jpg" src="loading.gif" alt="å›¾ç‰‡">
                    <div class="promotion">æ¨å¹¿å†…å®¹</div>
                    <p>æ›´å¤šå†…å®¹</p>
                </article>
            `;
            
            const { Extractor } = Trafilatura;
            const extractor = new Extractor({
                format: 'markdown',
                include_images: true
            });
            
            // é“¾å¼æ·»åŠ å¤šä¸ªè§„åˆ™
            extractor
                .addPreprocessingRule('removeAds', {
                    filter: ['.ad', '.promotion'],
                    action: () => null
                })
                .addPreprocessingRule('fixImages', {
                    filter: 'img[data-lazy-src]',
                    action: (node) => {
                        node.src = node.getAttribute('data-lazy-src');
                        node.removeAttribute('data-lazy-src');
                    }
                });
            
            const result = Trafilatura.extract(html, extractor);
            
            const hasContent = result && result.includes('æ­£æ–‡');
            const noAds = result && !result.includes('å¹¿å‘Š') && !result.includes('æ¨å¹¿');
            const hasImage = result && result.includes('image.jpg');
            
            const code = `extractor
  .addPreprocessingRule('removeAds', {...})
  .addPreprocessingRule('fixImages', {...});`;
            
            displayResult(4, 
                hasContent && noAds && hasImage, 
                hasContent && noAds && hasImage ? 'æˆåŠŸåº”ç”¨å¤šä¸ªè§„åˆ™' : 'å¤šè§„åˆ™åº”ç”¨å¤±è´¥',
                code,
                result
            );
        }

        // æµ‹è¯• 5: ä½¿ç”¨å‡½æ•°è¿‡æ»¤å™¨
        function test5() {
            const html = `
                <article>
                    <h1>è‡ªå®šä¹‰è¿‡æ»¤</h1>
                    <div data-type="content">ä¿ç•™å†…å®¹</div>
                    <div data-type="ignore">å¿½ç•¥å†…å®¹</div>
                    <p>æ­£æ–‡</p>
                    <div data-type="ignore">æ›´å¤šå¿½ç•¥</div>
                </article>
            `;
            
            const { Extractor } = Trafilatura;
            const extractor = new Extractor({
                format: 'markdown'
            });
            
            // ä½¿ç”¨å‡½æ•°è¿‡æ»¤å™¨
            extractor.addPreprocessingRule('removeIgnored', {
                filter: (node) => {
                    return node.getAttribute && node.getAttribute('data-type') === 'ignore';
                },
                action: () => null
            });
            
            const result = Trafilatura.extract(html, extractor);
            
            const hasContent = result && result.includes('ä¿ç•™å†…å®¹');
            const noIgnored = result && !result.includes('å¿½ç•¥å†…å®¹');
            
            const code = `extractor.addPreprocessingRule('removeIgnored', {
  filter: (node) => {
    return node.getAttribute('data-type') === 'ignore';
  },
  action: () => null
});`;
            
            displayResult(5, 
                hasContent && noIgnored, 
                hasContent && noIgnored ? 'æˆåŠŸä½¿ç”¨å‡½æ•°è¿‡æ»¤å™¨' : 'å‡½æ•°è¿‡æ»¤å™¨å¤±è´¥',
                code,
                result
            );
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        window.addEventListener('load', () => {
            console.log('å¼€å§‹æµ‹è¯•é¢„å¤„ç†è§„åˆ™åŠŸèƒ½...');
            test1();
            test2();
            test3();
            test4();
            test5();
            console.log('æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
        });
    </script>
</body>
</html>

