<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–‡å­—é‡å¤é—®é¢˜ä¿®å¤éªŒè¯</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding: 20px;
    background: #f5f5f5;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  h1 {
    color: #333;
    margin-bottom: 10px;
  }
  
  .subtitle {
    color: #666;
    margin-bottom: 30px;
  }
  
  .section {
    margin-bottom: 30px;
  }
  
  .section h2 {
    color: #444;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #667eea;
  }
  
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    border-left: 3px solid #667eea;
  }
  
  .stat-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 5px;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #667eea;
  }
  
  .result-box {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin-top: 10px;
    max-height: 400px;
    overflow-y: auto;
  }
  
  .result-box pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
  }
  
  .check-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .check-item.success {
    background: #d4edda;
    color: #155724;
  }
  
  .check-item.warning {
    background: #fff3cd;
    color: #856404;
  }
  
  .check-item.error {
    background: #f8d7da;
    color: #721c24;
  }
  
  .icon {
    font-size: 1.2rem;
  }
  
  button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.2s;
  }
  
  button:hover {
    transform: translateY(-2px);
  }
  
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .loading {
    display: none;
    text-align: center;
    padding: 20px;
    color: #666;
  }
  
  .loading.active {
    display: block;
  }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ”§ æ–‡å­—é‡å¤é—®é¢˜ä¿®å¤éªŒè¯</h1>
  <p class="subtitle">æµ‹è¯•ä¿®å¤åçš„Trafilaturaæ˜¯å¦è¿˜å­˜åœ¨æ–‡å­—é‡å¤é—®é¢˜</p>
  
  <div class="section">
    <h2>æµ‹è¯•æ­¥éª¤</h2>
    <button id="runTest" onclick="runTest()">å¼€å§‹æµ‹è¯•</button>
    <div id="loading" class="loading">æ­£åœ¨æµ‹è¯•...</div>
  </div>
  
  <div id="results" style="display: none;">
    <div class="section">
      <h2>æå–ç»Ÿè®¡</h2>
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">æå–æ—¶é—´</div>
          <div class="stat-value" id="extractTime">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">è¾“å‡ºé•¿åº¦</div>
          <div class="stat-value" id="outputLength">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">åŸæ–‡ä»¶é•¿åº¦</div>
          <div class="stat-value" id="oldLength">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">é•¿åº¦å˜åŒ–</div>
          <div class="stat-value" id="lengthChange">-</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2>é‡å¤æ£€æŸ¥ç»“æœ</h2>
      <div id="checkResults"></div>
    </div>
    
    <div class="section">
      <h2>æå–ç»“æœé¢„è§ˆï¼ˆå‰1000å­—ç¬¦ï¼‰</h2>
      <div class="result-box">
        <pre id="resultPreview"></pre>
      </div>
    </div>
  </div>
</div>

<script src="dist/trafilatura.browser.js"></script>
<script>
async function runTest() {
  const button = document.getElementById('runTest');
  const loading = document.getElementById('loading');
  const results = document.getElementById('results');
  
  button.disabled = true;
  loading.classList.add('active');
  results.style.display = 'none';
  
  try {
    // è¯»å–test.html
    const response = await fetch('test.html');
    const html = await response.text();
    
    console.log('HTMLæ–‡ä»¶åŠ è½½æˆåŠŸï¼Œå¤§å°:', (html.length / 1024).toFixed(2), 'KB');
    
    // æå–å†…å®¹
    const startTime = performance.now();
    const result = Trafilatura.extract(html, {
      format: 'markdown',
      with_metadata: true,
      include_images: true,
      include_links: true,
      include_formatting: true
    });
    const endTime = performance.now();
    
    if (!result) {
      throw new Error('æå–å¤±è´¥ï¼Œè¿”å›null');
    }
    
    // æ˜¾ç¤ºç»Ÿè®¡
    document.getElementById('extractTime').textContent = Math.round(endTime - startTime) + 'ms';
    document.getElementById('outputLength').textContent = result.length.toLocaleString() + ' å­—ç¬¦';
    
    // è¯»å–æ—§çš„test.mdï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    try {
      const oldMdResponse = await fetch('test.md');
      const oldMd = await oldMdResponse.text();
      document.getElementById('oldLength').textContent = oldMd.length.toLocaleString() + ' å­—ç¬¦';
      const change = result.length - oldMd.length;
      const changePercent = ((change / oldMd.length) * 100).toFixed(2);
      document.getElementById('lengthChange').textContent = 
        (change >= 0 ? '+' : '') + change.toLocaleString() + ' (' + changePercent + '%)';
    } catch (e) {
      document.getElementById('oldLength').textContent = 'N/A';
      document.getElementById('lengthChange').textContent = 'N/A';
    }
    
    // æ£€æŸ¥é‡å¤
    const checks = checkDuplication(result);
    displayChecks(checks);
    
    // æ˜¾ç¤ºé¢„è§ˆ
    document.getElementById('resultPreview').textContent = result.substring(0, 1000) + '\n\n... (æ€»å…± ' + result.length + ' å­—ç¬¦)';
    
    results.style.display = 'block';
    
  } catch (error) {
    console.error('æµ‹è¯•å¤±è´¥:', error);
    alert('æµ‹è¯•å¤±è´¥: ' + error.message);
  } finally {
    button.disabled = false;
    loading.classList.remove('active');
  }
}

function checkDuplication(text) {
  const checks = [];
  
  // å®šä¹‰å·²çŸ¥çš„é‡å¤æ¨¡å¼
  const patterns = [
    { name: 'æœ¬ç§‘å½•å–åé¢', pattern: 'æœ¬ç§‘å½•å–åé¢é¢„è®¡ä¸º450ä¸‡' },
    { name: 'é«˜è€ƒæŠ¥åäººæ•°', pattern: '2024å¹´å…¨å›½é«˜è€ƒæŠ¥åäººæ•°ä¸º1353ä¸‡' },
    { name: 'åŒå½•å–è¯­è¨€è¯¾ç¨‹', pattern: 'åŒå½•å–è¯­è¨€è¯¾ç¨‹' },
    { name: 'ç¾å›½å¤§å­¦', pattern: 'ç¾å›½å¤§å­¦' },
    { name: 'é™†æœ¬å­¦ç”Ÿ', pattern: 'é™†æœ¬å­¦ç”Ÿ' }
  ];
  
  for (const { name, pattern } of patterns) {
    // æ£€æŸ¥è¿ç»­é‡å¤ï¼ˆå¦‚ **text****text**ï¼‰
    const consecutiveRegex = new RegExp(`(\\*\\*${escapeRegex(pattern)}\\*\\*){2,}`, 'g');
    const consecutiveMatches = text.match(consecutiveRegex);
    
    if (consecutiveMatches) {
      checks.push({
        name: name,
        status: 'error',
        message: `å‘ç°è¿ç»­é‡å¤ ${consecutiveMatches.length} æ¬¡`
      });
      continue;
    }
    
    // æ£€æŸ¥æ€»å‡ºç°æ¬¡æ•°
    const allMatches = text.match(new RegExp(escapeRegex(pattern), 'g'));
    const count = allMatches ? allMatches.length : 0;
    
    if (count === 0) {
      checks.push({
        name: name,
        status: 'warning',
        message: 'æœªæ‰¾åˆ°è¯¥æ–‡æœ¬ï¼ˆå¯èƒ½ä¸åœ¨æµ‹è¯•HTMLä¸­ï¼‰'
      });
    } else if (count === 1) {
      checks.push({
        name: name,
        status: 'success',
        message: 'ä»…å‡ºç°1æ¬¡ï¼Œæ— é‡å¤'
      });
    } else {
      // æ£€æŸ¥æ˜¯å¦æ˜¯åˆç†çš„å¤šæ¬¡å‡ºç°ï¼ˆç›¸éš”è¶³å¤Ÿè¿œï¼‰
      const positions = [];
      const regex = new RegExp(escapeRegex(pattern), 'g');
      let match;
      while ((match = regex.exec(text)) !== null) {
        positions.push(match.index);
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰ç´§é‚»çš„é‡å¤ï¼ˆè·ç¦»å°äº100å­—ç¬¦ï¼‰
      let hasCloseRepeat = false;
      for (let i = 1; i < positions.length; i++) {
        if (positions[i] - positions[i-1] < 100) {
          hasCloseRepeat = true;
          break;
        }
      }
      
      if (hasCloseRepeat) {
        checks.push({
          name: name,
          status: 'error',
          message: `å‡ºç° ${count} æ¬¡ï¼Œå­˜åœ¨ç´§é‚»é‡å¤`
        });
      } else {
        checks.push({
          name: name,
          status: 'success',
          message: `å‡ºç° ${count} æ¬¡ï¼Œä½†åˆ†å¸ƒåˆç†`
        });
      }
    }
  }
  
  return checks;
}

function displayChecks(checks) {
  const container = document.getElementById('checkResults');
  container.innerHTML = '';
  
  const icons = {
    success: 'âœ…',
    warning: 'âš ï¸',
    error: 'âŒ'
  };
  
  for (const check of checks) {
    const div = document.createElement('div');
    div.className = `check-item ${check.status}`;
    div.innerHTML = `
      <span class="icon">${icons[check.status]}</span>
      <strong>${check.name}:</strong>
      <span>${check.message}</span>
    `;
    container.appendChild(div);
  }
  
  // æ€»ç»“
  const errorCount = checks.filter(c => c.status === 'error').length;
  const summary = document.createElement('div');
  summary.className = `check-item ${errorCount === 0 ? 'success' : 'error'}`;
  summary.style.marginTop = '15px';
  summary.style.fontWeight = 'bold';
  
  if (errorCount === 0) {
    summary.innerHTML = `
      <span class="icon">ğŸ‰</span>
      <span>æµ‹è¯•é€šè¿‡ï¼æœªå‘ç°æ–‡å­—é‡å¤é—®é¢˜ï¼Œä¿®å¤æˆåŠŸï¼</span>
    `;
  } else {
    summary.innerHTML = `
      <span class="icon">âš ï¸</span>
      <span>å‘ç° ${errorCount} ä¸ªé‡å¤é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚</span>
    `;
  }
  
  container.appendChild(summary);
}

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå‡†å¤‡çŠ¶æ€
window.addEventListener('load', () => {
  console.log('Trafilaturaç‰ˆæœ¬:', Trafilatura.version || '1.0.0');
  console.log('é¡µé¢å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®è¿›è¡ŒéªŒè¯');
});
</script>
</body>
</html>

