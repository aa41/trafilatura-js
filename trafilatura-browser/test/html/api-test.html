<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trafilatura API完整测试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 {
      color: #667eea;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #17a2b8; }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 300px;
    }
    .api-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    .api-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #28a745;
    }
    .api-item.missing {
      border-left-color: #dc3545;
    }
  </style>
</head>
<body>
  <h1>🚀 Trafilatura Browser - API完整测试</h1>
  
  <div class="test-section">
    <h2>1. 库加载状态</h2>
    <div id="library-status"></div>
  </div>
  
  <div class="test-section">
    <h2>2. API导出验证</h2>
    <div id="api-exports"></div>
  </div>
  
  <div class="test-section">
    <h2>3. 核心API测试</h2>
    <div id="core-api-test"></div>
  </div>
  
  <div class="test-section">
    <h2>4. extract()函数详细测试</h2>
    <div id="extract-test"></div>
  </div>
  
  <div class="test-section">
    <h2>5. 完整测试总结</h2>
    <div id="summary"></div>
  </div>

  <script src="../../dist/trafilatura.browser.js"></script>
  <script>
    const results = {
      passed: 0,
      failed: 0,
      tests: []
    };

    function log(msg, type = 'info') {
      const colors = { success: '#28a745', error: '#dc3545', info: '#17a2b8' };
      console.log(`%c${msg}`, `color: ${colors[type]}`);
    }

    function addTest(name, passed, details) {
      results.tests.push({ name, passed, details });
      if (passed) results.passed++;
      else results.failed++;
    }

    // 1. 检查库加载
    const libraryStatusDiv = document.getElementById('library-status');
    if (typeof Trafilatura !== 'undefined') {
      libraryStatusDiv.innerHTML = `
        <p class="success">✅ Trafilatura对象已加载</p>
        <p><strong>对象类型:</strong> ${typeof Trafilatura}</p>
        <p><strong>构造函数:</strong> ${Trafilatura.constructor.name}</p>
      `;
      addTest('库加载', true, 'Trafilatura对象存在');
    } else {
      libraryStatusDiv.innerHTML = '<p class="error">❌ Trafilatura对象未加载！</p>';
      addTest('库加载', false, 'Trafilatura对象不存在');
    }

    // 2. API导出验证
    const apiExportsDiv = document.getElementById('api-exports');
    const expectedAPIs = {
      '核心API': ['extract', 'bareExtraction'],
      '配置类': ['Extractor', 'Document', 'createExtractor', 'createDocument'],
      '基础提取': ['baseline', 'html2txt', 'basicCleaning'],
      '工具函数': ['loadHtml', 'trim', 'sanitize'],
      '处理函数': ['treeCleaning', 'pruneHtml', 'linkDensityTest'],
      '常量': ['MANUALLY_CLEANED', 'MANUALLY_STRIPPED', 'CUT_EMPTY_ELEMS']
    };

    let apiHTML = '';
    let allAPIsPresent = true;

    for (const [category, apis] of Object.entries(expectedAPIs)) {
      apiHTML += `<h3>${category}</h3><div class="api-list">`;
      for (const api of apis) {
        const exists = typeof Trafilatura[api] !== 'undefined';
        const typeStr = typeof Trafilatura[api];
        const className = exists ? 'api-item' : 'api-item missing';
        const icon = exists ? '✅' : '❌';
        apiHTML += `<div class="${className}">${icon} ${api}<br><small>(${typeStr})</small></div>`;
        if (!exists) allAPIsPresent = false;
        addTest(`API: ${api}`, exists, `类型: ${typeStr}`);
      }
      apiHTML += '</div>';
    }

    apiExportsDiv.innerHTML = apiHTML;

    // 3. 核心API测试
    const coreApiTestDiv = document.getElementById('core-api-test');
    let coreTestHTML = '';

    // 测试 extract 函数是否可调用
    if (typeof Trafilatura.extract === 'function') {
      coreTestHTML += '<p class="success">✅ Trafilatura.extract 是一个函数</p>';
      addTest('extract类型检查', true, 'extract是函数');
    } else {
      coreTestHTML += '<p class="error">❌ Trafilatura.extract 不是函数</p>';
      addTest('extract类型检查', false, `extract是${typeof Trafilatura.extract}`);
    }

    // 测试其他核心API
    ['bareExtraction', 'baseline', 'loadHtml'].forEach(api => {
      if (typeof Trafilatura[api] === 'function') {
        coreTestHTML += `<p class="success">✅ Trafilatura.${api} 可用</p>`;
        addTest(`${api}可用性`, true, '函数存在');
      } else {
        coreTestHTML += `<p class="error">❌ Trafilatura.${api} 不可用</p>`;
        addTest(`${api}可用性`, false, '函数不存在');
      }
    });

    coreApiTestDiv.innerHTML = coreTestHTML;

    // 4. extract()函数详细测试
    const extractTestDiv = document.getElementById('extract-test');
    let extractTestHTML = '';

    try {
      const testHTML = `
        <html>
          <head>
            <title>测试页面</title>
          </head>
          <body>
            <nav>导航栏</nav>
            <article>
              <h1>文章标题</h1>
              <p>这是第一段内容，包含实际的文章内容。</p>
              <p>这是第二段内容，也是文章的一部分。</p>
            </article>
            <footer>页脚</footer>
          </body>
        </html>
      `;

      log('开始extract测试...', 'info');
      const result = Trafilatura.extract(testHTML);
      
      extractTestHTML += '<h3>测试输入</h3>';
      extractTestHTML += `<pre>${testHTML.trim()}</pre>`;
      
      extractTestHTML += '<h3>提取结果</h3>';
      extractTestHTML += `<p><strong>结果类型:</strong> ${typeof result}</p>`;
      extractTestHTML += `<p><strong>结果长度:</strong> ${result ? result.length : 0} 字符</p>`;
      
      if (result) {
        extractTestHTML += '<h4>提取的内容:</h4>';
        extractTestHTML += `<pre>${result}</pre>`;
        
        // 验证提取的内容
        const checks = {
          '包含标题': result.includes('文章标题') || result.includes('标题'),
          '包含内容': result.includes('第一段内容') || result.includes('第二段内容'),
          '不包含导航': !result.includes('导航栏'),
          '不包含页脚': !result.includes('页脚')
        };
        
        extractTestHTML += '<h4>内容验证:</h4><ul>';
        for (const [check, passed] of Object.entries(checks)) {
          extractTestHTML += `<li class="${passed ? 'success' : 'error'}">${passed ? '✅' : '❌'} ${check}</li>`;
          addTest(`extract: ${check}`, passed, '内容检查');
        }
        extractTestHTML += '</ul>';
        
        addTest('extract函数执行', true, `返回${result.length}字符`);
      } else {
        extractTestHTML += '<p class="error">❌ extract返回了空结果</p>';
        addTest('extract函数执行', false, '返回空结果');
      }
      
    } catch (error) {
      extractTestHTML += `<p class="error">❌ extract测试失败</p>`;
      extractTestHTML += `<pre class="error">${error.message}\n\n${error.stack}</pre>`;
      addTest('extract函数执行', false, error.message);
      log('Extract测试失败: ' + error.message, 'error');
    }

    extractTestDiv.innerHTML = extractTestHTML;

    // 5. 总结
    const summaryDiv = document.getElementById('summary');
    const total = results.passed + results.failed;
    const passRate = total > 0 ? ((results.passed / total) * 100).toFixed(1) : 0;
    
    summaryDiv.innerHTML = `
      <h3>${results.failed === 0 ? '✅ 所有测试通过！' : '⚠️ 部分测试失败'}</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
        <div style="text-align: center; padding: 20px; background: #d4edda; border-radius: 8px;">
          <div style="font-size: 36px; font-weight: bold; color: #28a745;">${results.passed}</div>
          <div>通过</div>
        </div>
        <div style="text-align: center; padding: 20px; background: ${results.failed > 0 ? '#f8d7da' : '#e2e3e5'}; border-radius: 8px;">
          <div style="font-size: 36px; font-weight: bold; color: ${results.failed > 0 ? '#dc3545' : '#6c757d'};">${results.failed}</div>
          <div>失败</div>
        </div>
        <div style="text-align: center; padding: 20px; background: #d1ecf1; border-radius: 8px;">
          <div style="font-size: 36px; font-weight: bold; color: #17a2b8;">${passRate}%</div>
          <div>通过率</div>
        </div>
      </div>
      <details>
        <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 4px;">
          <strong>查看所有测试详情（${total}个测试）</strong>
        </summary>
        <ul style="margin-top: 10px;">
          ${results.tests.map(t => 
            `<li class="${t.passed ? 'success' : 'error'}">
              ${t.passed ? '✅' : '❌'} ${t.name} - ${t.details}
            </li>`
          ).join('')}
        </ul>
      </details>
    `;

    // 控制台输出
    log('='.repeat(50), 'info');
    log(`测试完成: ${results.passed}/${total} 通过 (${passRate}%)`, results.failed === 0 ? 'success' : 'error');
    log('='.repeat(50), 'info');
  </script>
</body>
</html>

